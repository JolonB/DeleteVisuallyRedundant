#!/usr/bin/env python3

import argparse
import os
import re

dupsFile = "dups.txt"  # TODO why isn't this const?
# TODO change everything to snake_case

parser = argparse.ArgumentParser(
	prog="DeleteVisuallyRedundant",
	description="Delete visually similar images. Retain only the largest and oldest image.",
)
parser.add_argument("filename")
parser.add_argument("-r", "--retain", action="store_true", help="Retain the dups.txt file generated by findimagedups")
parser.add_argument("-d", "--dry-run", action="store_true", help="Print the names of files without actually deleting them")
args = parser.parse_args()

filepath = args.filename  # TODO why is this global???
toRemoveDupFile = not args.retain
toDryRun = args.dry_run

# TODO can this be run using Python instead of system calls?
os.system("findimagedupes -R \"{}\" > \"{}\"".format(filepath, dupsFile))

def deleteAllButLargestAndOldest(filepaths):
	# TODO add comments!!
	maxSize = 0
	maxFilepaths = []
	remainingFilepaths = []

	# TODO tidy all of this up
	for filepath in filepaths:
		size = os.stat(filepath).st_size
		if (size > maxSize):
			maxSize = size

	for filepath in filepaths:
		size = os.stat(filepath).st_size

		if(size < maxSize):
			print("D:", filepath)
			if toDryRun == False:
				os.remove(filepath)
		elif (size == maxSize):
			maxFilepaths.append(filepath)

	if (len(maxFilepaths) > 1):
		oldestModifiedTime = float("inf")

		for filepath in maxFilepaths:
			modifiedTime = os.stat(filepath).st_mtime

			if (modifiedTime < oldestModifiedTime):
				oldestModifiedTime = modifiedTime

		for filepath in maxFilepaths:
			modifiedTime = os.stat(filepath).st_mtime

			if(modifiedTime > oldestModifiedTime):
				print("D:", filepath)
				if toDryRun == False:
					os.remove(filepath)
			elif (modifiedTime == oldestModifiedTime):
				remainingFilepaths.append(filepath)

	# Remove all but one duplicate if any still exist
	for filepath in remainingFilepaths[1:]:
		if toDryRun == False:
			os.remove(filepath)

# TODO def main() and if __name__ == "__main__"
# TODO maybe make this global
filename_regex = re.compile("(.+?\.(?:jpe?g|png|gif))(?:\s+|$)", flags=re.IGNORECASE)
with open(dupsFile, 'r') as fp:
	# TODO why are we enumerating??
	for cnt, line in enumerate(fp):
		matches = filename_regex.findall(line)

		deleteAllButLargestAndOldest(matches)

if toRemoveDupFile:
	os.remove(dupsFile)

